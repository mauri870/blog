<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Writing an Asterisk PBX module in Rust and C | Mauri870&#39;s dev blog</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="Asterisk modules are commonly written in C, but what about writing an Asterisk module in Rust? Let&rsquo;s find out.">
<meta name="generator" content="Hugo 0.145.0">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">


  
    
    <link rel="stylesheet" href="https://blog.mauri870.com/css/custom.css">
  


<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
  







  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">‚Üê</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
		<a class="button" href="https://blog.mauri870.com/posts/writing-an-asterisk-pbx-module-in-rust-and-c/">Subscribe</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Writing an Asterisk PBX module in Rust and C</h1>

    <div class="tip">
        <time datetime="2019-05-03 13:00:00 -0300 -03">May 3, 2019</time>
        <span class="split">
          ¬∑
        </span>
        <span>
          1190 words
        </span>
        <span class="split">
          ¬∑
        </span>
        <span>
          6 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#1-agi-to-the-rescue">1. AGI to the rescue</a></li>
    <li><a href="#2-rust-ffi">2. Rust FFI</a></li>
    <li><a href="#3-loading-and-testing-the-module">3. Loading and testing the module</a></li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <p>Asterisk modules are commonly written in C, but what about writing an Asterisk module in Rust? Let&rsquo;s find out.</p>
<hr>
<p>As I&rsquo;ve already explained in an <a href="/blog/posts/audio-spectrograms-in-tensorflow">older post</a>, we have a Deep Learning microservice responsible for <a href="https://en.wikipedia.org/wiki/Auto_dialer#Answering_machine_detection" target="_blank" rel="noopener">Answering Machine Detection(AMD)</a>. The problem is how to integrate this external service and make it accessible whitin an Asterisk dialplan.</p>
<h2 id="1-agi-to-the-rescue">1. AGI to the rescue <a href="#1-agi-to-the-rescue" class="anchor">üîó</a></h2><p>Our first attempt was to invoke a program acting as a client for the external service. Using the AGI application we&rsquo;re able to spawn our client within the dialplan, which is just a golang program.</p>
<p>The client just sends a HTTP request to the AMD service with the initial recorded audio of the outbound call and some metadata and receives back a json response containing the prediction results. The relevant dialplan configuration looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>; ommitted
</span></span><span style="display:flex;"><span>same <span style="color:#666">=&gt;</span>		n,Set(recording_amd<span style="color:#666">=/</span><span style="color:#a2f;font-weight:bold">var</span><span style="color:#666">/</span>spool<span style="color:#666">/</span>asterisk<span style="color:#666">/</span>monitor<span style="color:#666">/$</span>{EXTEN}<span style="color:#666">-$</span>{UNIQUEID}_amd<span style="color:#666">-</span><span style="color:#a2f;font-weight:bold">in</span>) ; Set a variable containing the recording path
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,Wait(<span style="color:#666">0.3</span>)
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,MixMonitor(<span style="color:#666">$</span>{recording_amd}<span style="color:#666">.</span>gsm) ; Start recording the call
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,Playback(silence<span style="color:#666">/</span><span style="color:#666">2</span>) ; Play <span style="color:#666">2</span>s silence
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,StopMixMonitor() ; Stop the recording
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,AGI(amd<span style="color:#666">-</span>client,<span style="color:#666">$</span>{recording_amd}<span style="color:#666">.</span>gsm) ; Invoke our client
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,NoOp(<span style="color:#666">$</span>{amd_result}) ; Does nothing<span style="color:#666">.</span> The variable amd_result contains the prediction result<span style="color:#666">.</span>
</span></span><span style="display:flex;"><span>; omitted
</span></span></code></pre></div><p>This works well, but since the migration of our architecture to Kubernetes (also described <a href="/blog/posts/gsutil-leak">in this post</a>) we started to face some problems, mainly involving <a href="https://en.wikipedia.org/wiki/Out_of_memory" target="_blank" rel="noopener">OOM</a> scenarios in our Kubernetes nodes. After much research and debug we find out that when the OOM errors occurs the pods have a lot of zombie processes of the amd-client. Since we can&rsquo;t found the root cause and I was already thinking of writing a native module, we decide to go ahead and give Rust a try.</p>
<h2 id="2-rust-ffi">2. Rust FFI <a href="#2-rust-ffi" class="anchor">üîó</a></h2><p>The problem of adopting the Rust language for this project is that Rust doesn&rsquo;t have a stabilized ABI and does not support <a href="https://en.wikipedia.org/wiki/C_preprocessor" target="_blank" rel="noopener">CPP</a> stuff, like macros and define. Then we have no choice but to write some C code to glue things together along with a library in Rust that export(<code>#[no_mangle]</code>) the functions and structs(<code>#[repr(C)]</code>) needed as a shared or static lib.</p>
<p>The following resources helped me a lot:</p>
<ul>
<li><a href="http://jakegoulding.com/rust-ffi-omnibus" target="_blank" rel="noopener">Rust FFI Omnibus</a></li>
<li><a href="https://doc.rust-lang.org/beta/nomicon/ffi.html" target="_blank" rel="noopener">Rust Nomicon</a></li>
</ul>
<p>For example our prediction struct looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#b44;font-style:italic">/// A struct that wraps the code and confidence for a prediction
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#080">#[repr(C)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">struct</span> <span style="color:#00f">AmdPrediction</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>code: <span style="color:#0b0;font-weight:bold">u32</span>,<span style="color:#bbb">       </span><span style="color:#080;font-style:italic">// The integer prediction code
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#bbb">    </span>confidence: <span style="color:#0b0;font-weight:bold">f32</span>,<span style="color:#bbb"> </span><span style="color:#080;font-style:italic">// The confidence of the prediction
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>As you can see, we use <code>repr(C)</code> to allow this struct to be called from C code. We also have a function to lookup the string label for a given prediction code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#b44;font-style:italic">/// Retrieve the label corresponding to an amd status code
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#080">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#b44">&#34;C&#34;</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">fn</span> <span style="color:#00a000">amd_label_name</span>(code: <span style="color:#0b0;font-weight:bold">u32</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#666">*</span><span style="color:#a2f;font-weight:bold">const</span><span style="color:#bbb"> </span>c_char<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">let</span><span style="color:#bbb"> </span>label: <span style="color:#a2f">&amp;</span>[<span style="color:#0b0;font-weight:bold">u8</span>]<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">match</span><span style="color:#bbb"> </span>code<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#800">AMD_STATUS_MACHINE</span><span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span><span style="color:#b44">b</span><span style="color:#b44">&#34;machine</span><span style="color:#b62;font-weight:bold">\0</span><span style="color:#b44">&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#800">AMD_STATUS_HUMAN</span><span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span><span style="color:#b44">b</span><span style="color:#b44">&#34;human</span><span style="color:#b62;font-weight:bold">\0</span><span style="color:#b44">&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#800">AMD_STATUS_SILENCE</span><span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span><span style="color:#b44">b</span><span style="color:#b44">&#34;silence</span><span style="color:#b62;font-weight:bold">\0</span><span style="color:#b44">&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#800">AMD_STATUS_ERROR</span><span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span><span style="color:#b44">b</span><span style="color:#b44">&#34;error</span><span style="color:#b62;font-weight:bold">\0</span><span style="color:#b44">&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>_<span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span><span style="color:#b44">b</span><span style="color:#b44">&#34;unknown</span><span style="color:#b62;font-weight:bold">\0</span><span style="color:#b44">&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>label.as_ptr()<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#a2f;font-weight:bold">const</span><span style="color:#bbb"> </span>c_char<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>An interesting fact is that Rust do not accept null values, but it can in fact create a null raw pointer using <code>std::ptr::null</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#b44;font-style:italic">/// Performs the inference for a given file and return a pointer to an `AmdPrediction`
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#080">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#b44">&#34;C&#34;</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">fn</span> <span style="color:#00a000">amd_inference</span>(file: <span style="color:#666">*</span><span style="color:#a2f;font-weight:bold">const</span><span style="color:#bbb"> </span>c_char)<span style="color:#bbb"> </span>-&gt; <span style="color:#666">*</span><span style="color:#a2f;font-weight:bold">mut</span><span style="color:#bbb"> </span>AmdPrediction<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">if</span><span style="color:#bbb"> </span>file.is_null()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">return</span><span style="color:#bbb"> </span>std::ptr::null_mut();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">let</span><span style="color:#bbb"> </span>file<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>CStr::from_ptr(file).to_str()<span style="color:#bbb"> </span>}.unwrap();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">let</span><span style="color:#bbb"> </span>prediction<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">match</span><span style="color:#bbb"> </span>amd_do_inference(file)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f">Ok</span>(pred)<span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span>pred,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f">Err</span>(e)<span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>error::set_last_error(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">return</span><span style="color:#bbb"> </span>std::ptr::null_mut();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#a2f">Box</span>::into_raw(<span style="color:#a2f">Box</span>::new(prediction))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>The memory that is allocated by Rust, should be freed by Rust. So we also need to export a function to free up the allocated memory.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#b44;font-style:italic">/// Free an `AmdPrediction` pointer
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#080">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#b44">&#34;C&#34;</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">fn</span> <span style="color:#00a000">amd_prediction_free</span>(ptr: <span style="color:#666">*</span><span style="color:#a2f;font-weight:bold">mut</span><span style="color:#bbb"> </span>AmdPrediction)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">if</span><span style="color:#bbb"> </span>ptr.is_null()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">return</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">unsafe</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f">Box</span>::from_raw(ptr);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>By creating a Box using a raw pointer, we bring it back to the rust land so it&rsquo;ll be freed when they reach the end of the scope at the end of the unsafe block.</p>
<p>Another interesting topic is how to handle errors in a rust library. Since we need to expose those errors to C, a common approach is to use a thread local variable to keep track of the last error that occured in the library, exposing a function to retrieve the error, something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">use</span><span style="color:#bbb"> </span>std::cell::RefCell;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">use</span><span style="color:#bbb"> </span>std::ffi::CString;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">use</span><span style="color:#bbb"> </span>std::error::Error<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">as</span><span style="color:#bbb"> </span>StdError;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">use</span><span style="color:#bbb"> </span>libc::c_char;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>thread_local!<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b44;font-style:italic">/// An `errno`-like thread-local variable which keeps track of the most
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#bbb">    </span><span style="color:#b44;font-style:italic">/// recent error to occur in the library.
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#800">LAST_ERROR</span>: <span style="color:#00f">RefCell</span><span style="color:#666">&lt;</span><span style="color:#a2f">Option</span><span style="color:#666">&lt;</span>LastError<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>RefCell::new(<span style="color:#a2f">None</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b44;font-style:italic">/// Keeps track of the latest error
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#080">#[derive(Debug)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">struct</span> <span style="color:#00f">LastError</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>error: <span style="color:#a2f">Box</span><span style="color:#666">&lt;</span>StdError<span style="color:#666">&gt;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>c_string: <span style="color:#00f">CString</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b44;font-style:italic">/// A C friendly struct to hold the latest error message
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#080">#[derive(Debug, PartialEq)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080">#[repr(C)]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">struct</span> <span style="color:#00f">MyLibError</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>msg: <span style="color:#666">*</span><span style="color:#a2f;font-weight:bold">const</span><span style="color:#bbb"> </span>c_char,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-style:italic">// A default error for when no error has actually occurred
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">impl</span><span style="color:#bbb"> </span><span style="color:#a2f">Default</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">for</span><span style="color:#bbb"> </span>MyLibError<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">fn</span> <span style="color:#00a000">default</span>()<span style="color:#bbb"> </span>-&gt; <span style="color:#00f">MyLibError</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>MyLibError<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>msg: <span style="color:#00f">std</span>::ptr::null(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b44;font-style:italic">/// Change LAST_ERROR with the last error that occured in the library
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#a2f;font-weight:bold">pub</span><span style="color:#bbb"> </span>(<span style="color:#a2f;font-weight:bold">crate</span>)<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">fn</span> <span style="color:#00a000">set_last_error</span>(err: <span style="color:#a2f">Box</span><span style="color:#666">&lt;</span>StdError<span style="color:#666">&gt;</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#800">LAST_ERROR</span>.with(<span style="color:#666">|</span>l<span style="color:#666">|</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">let</span><span style="color:#bbb"> </span>c_string<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>CString::new(err.to_string()).unwrap_or_default();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">let</span><span style="color:#bbb"> </span>new_error<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>LastError<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>error: <span style="color:#00f">err</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>c_string,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#666">*</span>l.borrow_mut()<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#a2f">Some</span>(new_error);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b44;font-style:italic">/// Retrieve the most recent error
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#080">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">unsafe</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#b44">&#34;C&#34;</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">fn</span> <span style="color:#00a000">mylib_last_error</span>()<span style="color:#bbb"> </span>-&gt; <span style="color:#00f">AmdError</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#800">LAST_ERROR</span>.with(<span style="color:#666">|</span>l<span style="color:#666">|</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">match</span><span style="color:#bbb"> </span>l.borrow().as_ref()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f">Some</span>(err)<span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span>MyLibError<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>msg: <span style="color:#00f">err</span>.c_string.as_ptr(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#a2f">None</span><span style="color:#bbb"> </span><span style="color:#666">=&gt;</span><span style="color:#bbb"> </span>MyLibError::default(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>})<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b44;font-style:italic">/// Clear the last error
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic"></span><span style="color:#080">#[no_mangle]</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">extern</span><span style="color:#bbb"> </span><span style="color:#b44">&#34;C&#34;</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">fn</span> <span style="color:#00a000">mylib_clear_last_error</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#800">LAST_ERROR</span>.with(<span style="color:#666">|</span>l<span style="color:#666">|</span><span style="color:#bbb"> </span>l.borrow_mut().take());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>This makes it easy to set errors (by using the <code>set_last_error</code>) and to retrieve then in C, using the <code>mylib_last_error</code> function. The memory of the error is also freed when another error occurs.</p>
<p>In order to automate the library header generation we use cbindgen by invoking it in our build.rs file so Cargo can generate it  when building our library. We still need make tho in order to compile the asterisk module since the rust part is just the library. Our project was based on <a href="https://github.com/zaf/Asterisk-eSpeak" target="_blank" rel="noopener">this module</a> as an initial template.</p>
<h2 id="3-loading-and-testing-the-module">3. Loading and testing the module <a href="#3-loading-and-testing-the-module" class="anchor">üîó</a></h2><p>In order to load the module in asterisk we need to put the rust library shared object into the <code>$LD_LIBRARY_PATH</code>, run <code>ldconfig</code> and put the path to the shared object file of the module in the asterisk <code>modules.conf</code> file.</p>
<p>Then we&rsquo;re ready to load the module:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@e3b75b6f6141:/# asterisk -x <span style="color:#b44">&#34;module load app_3cplus_amd&#34;</span>
</span></span><span style="display:flex;"><span>Loaded app_3cplus_amd
</span></span><span style="display:flex;"><span>root@e3b75b6f6141:/# asterisk -x <span style="color:#b44">&#34;module show like app_3cplus_amd&#34;</span>
</span></span><span style="display:flex;"><span>Module                         Description                              Use Count  Status      Support Level
</span></span><span style="display:flex;"><span>app_3cplus_amd.so              AMD interface <span style="color:#a2f;font-weight:bold">for</span> the 3cplus/amd project <span style="color:#666">0</span>          Running           unknown
</span></span><span style="display:flex;"><span><span style="color:#666">1</span> modules loaded
</span></span></code></pre></div><p>And the dialplan config:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>; ommitted
</span></span><span style="display:flex;"><span>same <span style="color:#666">=&gt;</span>		n,Set(recording_amd<span style="color:#666">=/</span><span style="color:#a2f;font-weight:bold">var</span><span style="color:#666">/</span>spool<span style="color:#666">/</span>asterisk<span style="color:#666">/</span>monitor<span style="color:#666">/$</span>{EXTEN}<span style="color:#666">-$</span>{UNIQUEID}_amd<span style="color:#666">-</span><span style="color:#a2f;font-weight:bold">in</span>) ; Set a variable containing the recording path
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,Wait(<span style="color:#666">0.3</span>)
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,MixMonitor(<span style="color:#666">$</span>{recording_amd}<span style="color:#666">.</span>gsm) ; Start recording the call
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,Playback(silence<span style="color:#666">/</span><span style="color:#666">2</span>) ; Play <span style="color:#666">2</span>s silence
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,StopMixMonitor() ; Stop the recording
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> ; Easy peasy
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,<span style="color:#666">3</span>cplusAMD(<span style="color:#666">$</span>{recording_amd}<span style="color:#666">.</span>gsm) ; Invoke our native application
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> same <span style="color:#666">=&gt;</span>	n,NoOp(<span style="color:#666">$</span>{amd_result}) ; Does nothing<span style="color:#666">.</span> The variable amd_result contains the prediction result<span style="color:#666">.</span>
</span></span><span style="display:flex;"><span>; omitted
</span></span></code></pre></div><p>We&rsquo;re running this module in production for 2 weeks now. The OOM problems ceased, the resource usage is lower and we are pretty happy to put all together and this is the first project ever using Rust at our company and it won&rsquo;t be the last for sure.</p>
<p>That&rsquo;s it for now, see you again next time.</p>
    </div>

    
        <div class="tags">
            
                <a href="https://blog.mauri870.com/tags/rust">Rust</a>
            
                <a href="https://blog.mauri870.com/tags/asterisk">Asterisk</a>
            
                <a href="https://blog.mauri870.com/tags/c">C</a>
            
        </div>
    
    
    
  <div id="comment">
    
    
  </div>


</section>


    </main>
    
    <footer id="footer">
    

    <div class="copyright">
    
       ¬© Copyright 
       2025 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Mauri de Souza Meneguzzo
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-mini'>nodejh</a>
      </div>
    
</footer>



  </body>
</html>
